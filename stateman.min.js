!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):"object"==typeof exports?exports.StateMan=e():t.StateMan=e()}(this,function(){return function(t){function e(i){if(n[i])return n[i].exports;var r=n[i]={exports:{},id:i,loaded:!1};return t[i].call(r.exports,r,r.exports,e),r.loaded=!0,r.exports}var n={};return e.m=t,e.c=n,e.p="",e(0)}([function(t,e,n){var i=n(1);i.Histery=n(2),i.util=n(3),i.State=n(4),t.exports=i},function(t,e,n){function i(t){return this instanceof i==!1?new i(t):(t=t||{},t.history&&(this.history=t.history),this._states={},void(this.current=this.pending=this))}var r=n(4),a=n(2),s=(n(5),n(3)),o=r.prototype.state;s.extend(s.emitable(i),{state:function(t){var e=this.pending;return"string"==typeof t&&e.name&&(t=t.replace("~",e.name),e.parent&&(t=t.replace("^",e.parent.name||""))),o.apply(this,arguments)},start:function(t){return this.history||(this.history=new a(t)),this.history.on("change",s.bind(this._afterPathChange,this)),this.history.isStart||this.history.start(),this},go:function(t,e,n){if(e=e||{},"string"==typeof t&&(t=this.state(t)),e.encode!==!1){var i=t.encode(e.param);this.nav(i,{silent:!0,replace:e.replace}),this.path=i}return this._go(t,e,n),this},nav:function(t,e,n){return n&&(this._cb=n),this.history.nav(t,e),this._cb=null,this},decode:function(t){var e=t.split("?"),n=this._findQuery(e[1]);t=e[0];var i=this._findState(this,t);return i&&s.extend(i.param,n),i},encode:r.prototype.encode,notify:function(t,e){return this.state(t).emit("notify",e)},is:function(t,e,n){if(!t)return!1;var t=(t.name||t).trim(),i=this.pending,r=i.name,a=n?r===t:0===(r+".").indexOf(t+".");return a&&(!e||s.eql(e,this.param))},_afterPathChange:function(t){this.emit("history:change",t);var e=this.decode(t),n=this._cb;if(this.path=t,!e){var i=this.state("$notfound");return i&&this._go(i,{path:t},n),this.emit("404",{path:t})}this._go(e,{param:e.param},n)},_go:function(t,e,n){if("string"==typeof t&&(t=this.state(t)),!t)return s.log("destination is not defined");if(this.pending!==this.current){if(this.pending._pending)return s.log("beacuse "+this.pending.name+" is pending, the nav to ["+t.name+"] is be forbit"),this.emit("forbid",t),this.nav(this.current.encode(this.param),{silent:!0});s.log("naving to ["+this.current.name+"] will be stoped, trying to ["+t.name+"] now"),this.current=this.pending}this.param=e.param||{};var i=this.current,r=this._findBase(i,t),a=this;i!==t&&(this.previous=i,this.current=t,a.emit("begin"),this._leave(r,e,function(){a._enter(t,e,function(){a.emit("end"),"function"==typeof n&&n.call(a)})})),this._checkQueryAndParam(r,e)},_findQuery:function(t){var e=t&&t.split("&"),n={};if(e)for(var i=e.length,n={},r=0;i>r;r++){var a=e[r].split("=");n[a[0]]=a[1]}return n},_findState:function(t,e){var n,i,r=t._states;if(t.hasNext)for(var a in r)if(r.hasOwnProperty(a)&&(n=this._findState(r[a],e)))return n;return i=t.regexp&&t.decode(e),i?(t.param=i,t):!1},_findBase:function(t,e){if(!t||!e||t==this||e==this)return this;for(var n,i=t,r=e;i&&r;){for(n=r;n;){if(i===n)return n;n=n.parent}i=i.parent}return this},_enter:function(t,e,n){n=n||s.noop;var i=this.pending;if(i==t)return n();for(var r=[];t!==i&&t;)r.push(t),t=t.parent;this._enterOne(r,e,n)},_enterOne:function(t,e,n){var i=t.pop(),r=this;return i?(this.pending=i,i.done=function(){r._enterOne(t,e,n),i._pending=!1,i.done=null,i.visited=!0},void(i.enter?(i.enter(e),!i._pending&&i.done&&i.done()):i.done())):n()},_leave:function(t,e,n){return n=n||s.noop,t==this.pending?n():void this._leaveOne(t,e,n)},_leaveOne:function(t,e,n){if(t===this.pending)return n();var i=this.pending,r=this;i.done=function(){i.parent&&(r.pending=i.parent),r._leaveOne(t,e,n),i._pending=!1,i.done=null},i.leave?(i.leave(e),!i._pending&&i.done&&i.done()):i.done()},_checkQueryAndParam:function(t,e){for(var n=t;n!==this;)n.update&&n.update(e),n=n.parent}},!0),t.exports=i},function(t,e,n){function i(t){t=t||{},this.location=t.location||r.location,this.mode=t.mode||(t.html5&&r.history?h:o),this.html5=t.html5,r.hash||(this.mode=this.mode|h),this.prefix="#"+(t.prefix||""),this.rPrefix=new RegExp(this.prefix+"(.*)$"),this.interval=t.interval||1e3,this.root=t.root||"/",this.rRoot=new RegExp("^"+this.root),this._fixInitState(),this.autolink=t.autolink!==!1,this.curPath=void 0}var r=n(5),a=n(3),s=3,o=1,h=2;a.extend(a.emitable(i),{start:function(){var t=this.getPath();if(this._checkPath=a.bind(this.checkPath,this),!this.isStart){switch(this.isStart=!0,this.mode===s&&this._fixHashProbelm(t),this.mode){case o:r.on(window,"hashchange",this._checkPath);break;case h:r.on(window,"popstate",this._checkPath);break;case s:this._checkLoop()}this.autolink&&this._autolink(),this.curPath=t,this.emit("change",t)}},stop:function(){r.off(window,"hashchange",this._checkPath),r.off(window,"popstate",this._checkPath),clearTimeout(this.tid),this.isStart=!1,this._checkPath=null},checkPath:function(){var t=this.getPath(),e=this.curPath;t===e&&this.iframe&&(e=this.getPath(this.iframe.location)),t!==e&&(this.iframe&&this.nav(t,{silent:!0}),this.emit("change",this.curPath=t))},getPath:function(t){var e,t=t||this.location;return this.mode!==h?(e=t.href.match(this.rPrefix),e&&e[1]?e[1]:""):a.cleanPath((t.pathname+t.search||"").replace(this.rRoot,"/"))},nav:function(t,e){var n=this.iframe;e=e||{},t=a.cleanPath(t),this.curPath!=t&&(this.curPath=t,this.mode!==h?(this._setHash(this.location,t,e.replace),n&&this.getPath(n.location)!==t&&(e.replace||n.document.open().close(),this._setHash(this.iframe.location,t,e.replace))):history[e.replace?"replaceState":"pushState"]({},e.title||"",a.cleanPath(this.root+t)),e.silent||this.emit("change",t))},_autolink:function(){var t=(this.prefix,this);r.on(document.body,"click",function(e){var n=e.target||e.srcElement;if("a"===n.tagName.toLowerCase()){var i=(r.getHref(n)||"").match(t.rPrefix),a=i&&i[1]?i[1]:"";if(a)return e.preventDefault&&e.preventDefault(),t.nav(a,{force:!0}),e.returnValue=!1}})},_setHash:function(t,e,n){var i=t.href.replace(/(javascript:|#).*$/,"");n?t.replace(i+this.prefix+e):t.hash=this.prefix+e},_checkLoop:function(){var t=this;this.tid=setTimeout(function(){t._checkPath(),t._checkLoop()},this.interval)},_fixInitState:function(){var t,e,n=a.cleanPath(this.location.pathname);this.mode!==h&&this.html5?(e=n.replace(this.rRoot,""),e&&this.location.replace(this.root+this.prefix+e)):this.mode===h&&(t=this.location.hash.replace(this.prefix,""),t&&history.replaceState({},document.title,a.cleanPath(this.root+t)))},_fixHashProbelm:function(t){var e=document.createElement("iframe"),n=document.body;e.src="javascript:;",e.style.display="none",e.tabIndex=-1,e.title="",this.iframe=n.insertBefore(e,n.firstChild).contentWindow,this.iframe.document.open().close(),this.iframe.location.hash="#"+t}}),t.exports=i},function(t){function e(t){var e=0,i=[],r=0,a="";t=n.cleanPath(t);var s=t.replace(/\:([\w-]+)(?:\(([^\/]+?)\))?|(?:\(([^\/]+)\))|(\*{2,})|(\*(?!\*))/g,function(n,s,o,h,c,f,u){return u>e&&(a+=t.slice(e,u)),e=u+n.length,s?(a+="("+s+")",i.push(s),"("+(o||"[\\w-]+")+")"):(a+="("+r+")",i.push(r++),h?"("+h+")":c?"(.*)":f?"([^\\/]*)":void 0)});return e!==t.length&&(a+=t.slice(e)),{regexp:new RegExp("^"+s+"/?$"),keys:i,matches:a||t}}var n=t.exports={},i=[].slice,r={}.toString;n.extend=function(t,e,n){for(var i in e)(n||void 0===t[i])&&(t[i]=e[i]);return t},n.ocreate=Object.create||function(t){var e=function(){};return e.prototype=t,new e},n.slice=function(t,e){return i.call(t,e)},n.typeOf=function(t){return null==t?String(t):r.call(t).slice(8,-1).toLowerCase()},n.eql=function(t,e){var i=n.typeOf(t),r=n.typeOf(e);if(i!==r)return!1;if("object"===i){var a=!0;for(var s in t)n.eql(t[s],e[s])||(a=!1);for(var o in e)n.eql(t[o],e[o])||(a=!1);return a}return t===e},n.emitable=function(){var t={on:function(t,e){if("object"==typeof t)for(var n in t)this.on(n,t[n]);else{var i=this._handles||(this._handles={}),r=i[t]||(i[t]=[]);r.push(e)}return this},off:function(t,e){if(t&&this._handles||(this._handles={}),this._handles){var n,i=this._handles;if(n=i[t]){if(!e)return i[t]=[],this;for(var r=0,a=n.length;a>r;r++)if(e===n[r])return n.splice(r,1),this}return this}},emit:function(t){var e,i=n.slice(arguments,1),r=this._handles;if(!r||!(e=r[t]))return this;for(var a=0,s=e.length;s>a;a++)e[a].apply(this,i);return this}};return function(e){return e="function"==typeof e?e.prototype:e,n.extend(e,t)}}(),n.noop=function(){},n.bind=function(t,e){return function(){return t.apply(e,arguments)}};var a=/\/+/g,s=/\/$/;n.cleanPath=function(t){return("/"+t).replace(a,"/").replace(s,"")||"/"},n.log=function(t,e){"undefined"!=typeof console&&console[e||"log"](t)},n.normalize=e},function(t,e,n){function i(t){this._states={},this._pending=!1,this.visited=!1,t&&this.config(t)}var r=n(3);i.rCache={},r.extend(r.emitable(i),{state:function(t,e){if("object"===r.typeOf(t)){for(var n in t)this.state(n,t[n]);return this}var a,s,o,h=this._states,n=0;"string"==typeof t&&(t=t.split("."));var c=t.length,a=this,f=[];do{if(o=t[n],s=h[o],f.push(o),!s){if(!e)return;s=h[o]=new i,r.extend(s,{parent:a,manager:a.manager||a,name:f.join("."),currentName:o}),a.hasNext=!0,s.configUrl()}a=s,h=s._states}while(++n<c);return e?(s.config(e),this):a},config:function(t){if(t){t=this._getConfig(t);for(var e in t){var n=t[e];switch(e){case"url":"string"==typeof n&&(this.url=n,this.configUrl());break;case"events":this.on(n);break;default:this[e]=n}}}},_getConfig:function(t){return"function"==typeof t?{enter:t}:t},configUrl:function(){for(var t="",e=this;e;){if(t=("string"==typeof e.url?e.url:e.currentName||"")+"/"+t,0===t.indexOf("^/")){t=t.slice(1);break}e=e.parent}this.path=r.cleanPath("/"+t);var n=this.path.split("?");this.path=n[0],r.extend(this,r.normalize(this.path),!0)},encode:function(t,e){var n;"undefined"==typeof e?(n=this,e=t):n=this.state(t);var e=e||{},i="%",a=n.matches.replace(/\(([\w-]+)\)/g,function(t,n){var r=e[n]||"";return i+=n+"%",r})+"?";for(var s in e)-1===i.indexOf("%"+s+"%")&&(a+=s+"="+e[s]+"&");return r.cleanPath(a.replace(/(?:\?|&)$/,""))},decode:function(t){var e=this.regexp.exec(t),n=this.keys;if(e){for(var i={},r=0,a=n.length;a>r;r++)i[n[r]]=e[r+1];return i}return!1},async:function(){return this._pending=!0,this.done}}),t.exports=i},function(t){var e=window,n=document,i=t.exports={hash:"onhashchange"in e&&(!n.documentMode||n.documentMode>7),history:e.history&&"onpopstate"in e,location:e.location,getHref:function(t){return"href"in t?t.getAttribute("href",2):t.getAttribute("href")},on:"addEventListener"in e?function(t,e,n){return t.addEventListener(e,n)}:function(t,e,n){return t.attachEvent("on"+e,n)},off:"removeEventListener"in e?function(t,e,n){return t.removeEventListener(e,n)}:function(t,e,n){return t.detachEvent("on"+e,n)}};i.msie=parseInt((/msie (\d+)/.exec(navigator.userAgent.toLowerCase())||[])[1]),isNaN(i.msie)&&(i.msie=parseInt((/trident\/.*; rv:(\d+)/.exec(navigator.userAgent.toLowerCase())||[])[1]))}])});